<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>í¬ë…¸ì• ë½ â€” ê°ì • ì° í”Œë«í¼</title>
    <meta name="description" content="í¬ë…¸ì• ë½, ê°ì •ì„ í„¸ì–´ë†“ëŠ” ìµëª… ì° í”Œë«í¼. ê¸°ì¨Â·ë¶„ë…¸Â·ì‚¬ë‘Â·ì¦ê±°ì›€ì„ ë‚˜ëˆ„ê³  ê³µê°ë°›ìœ¼ì„¸ìš”." />
    <meta name="keywords" content="í¬ë…¸ì• ë½, ê°ì •, ìµëª…, ì°, ì»¤ë®¤ë‹ˆí‹°, ê³µê°, ì¼ìƒ" />
    <link rel="canonical" href="https://emote.funnyfunny.cloud/" />

    <meta property="og:title" content="í¬ë…¸ì• ë½ â€” ê°ì • ì° í”Œë«í¼" />
    <meta property="og:description" content="ê°ì •ì„ í„¸ì–´ë†“ëŠ” ìµëª… ì° í”Œë«í¼. ê¸°ì¨Â·ë¶„ë…¸Â·ì‚¬ë‘Â·ì¦ê±°ì›€ì„ ë‚˜ëˆ„ê³  ê³µê°ë°›ìœ¼ì„¸ìš”." />
    <meta property="og:image" content="https://dummyimage.com/1200x630/fef3c7/92400e&text=Emote" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='48'%3E%F0%9F%98%8A%3C/text%3E%3C/svg%3E" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              hui: { 50: '#fefce8', 100: '#fef9c3', 400: '#facc15', 500: '#eab308', 600: '#ca8a04' },
              no: { 50: '#fef2f2', 100: '#fee2e2', 400: '#f87171', 500: '#ef4444', 600: '#dc2626' },
              ae: { 50: '#fdf2f8', 100: '#fce7f3', 400: '#f472b6', 500: '#ec4899', 600: '#db2777' },
              rak: { 50: '#ecfdf5', 100: '#d1fae5', 400: '#34d399', 500: '#10b981', 600: '#059669' }
            }
          }
        }
      }
    </script>
    <style>
      :root { color-scheme: light; }
      body {
        background: linear-gradient(135deg, #fef3c7 0%, #fce7f3 50%, #d1fae5 100%);
        min-height: 100vh;
      }
      .glass {
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(0,0,0,0.08);
      }
      .tap { transition: transform 100ms ease; }
      .tap:active { transform: scale(0.97); }
      .emotion-btn { transition: all 150ms ease; }
      .emotion-btn.active { transform: scale(1.05); box-shadow: 0 8px 25px -5px currentColor; }
      .card-enter { animation: cardIn 300ms ease-out; }
      @keyframes cardIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
      .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
      .hot-badge { background: linear-gradient(135deg, #f97316, #ef4444); }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1204894220949193" crossorigin="anonymous"></script>
  </head>
  <body class="text-slate-800">
    <!-- Header -->
    <header class="sticky top-0 z-40 glass shadow-sm">
      <div class="max-w-3xl mx-auto px-4 py-3 flex items-center gap-3">
        <a href="#/" class="tap flex items-center gap-2 font-black text-lg">
          <span class="text-2xl">ğŸ˜Š</span>
          <span>í¬ë…¸ì• ë½</span>
          <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 border border-amber-200">BETA</span>
        </a>
        <div class="ml-auto flex items-center gap-2">
          <a href="https://funnyfunny.cloud/" target="_blank" rel="noopener" class="tap hidden sm:flex items-center gap-1 px-3 py-1.5 rounded-xl bg-slate-100 text-slate-600 text-sm font-semibold hover:bg-slate-200">
            ë‹¤ë¥¸ ì„œë¹„ìŠ¤ â†—
          </a>
          <button id="openWriteBtn" class="tap flex items-center gap-1 px-4 py-2 rounded-xl bg-gradient-to-r from-amber-400 to-pink-400 text-white font-bold shadow-lg hover:shadow-xl">
            âœï¸ ì° ì“°ê¸°
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-6">
      <!-- Hero -->
      <section class="glass rounded-3xl p-6 shadow-lg mb-6">
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
          <div>
            <h1 class="text-2xl sm:text-3xl font-black tracking-tight">
              ì˜¤ëŠ˜, ì–´ë–¤ <span class="bg-gradient-to-r from-amber-500 via-pink-500 to-emerald-500 bg-clip-text text-transparent">ê°ì •</span>ì´ì„¸ìš”?
            </h1>
            <p class="mt-1 text-slate-500 text-sm">ìµëª…ìœ¼ë¡œ ê°ì •ì„ í„¸ì–´ë†“ê³  ê³µê°ë°›ëŠ” ì° í”Œë«í¼</p>
          </div>
          <div id="emotionRatio" class="flex gap-1 text-xs font-bold">
            <span class="px-2 py-1 rounded-full bg-hui-100 text-hui-600">í¬ --%</span>
            <span class="px-2 py-1 rounded-full bg-no-100 text-no-600">ë…¸ --%</span>
            <span class="px-2 py-1 rounded-full bg-ae-100 text-ae-600">ì•  --%</span>
            <span class="px-2 py-1 rounded-full bg-rak-100 text-rak-600">ë½ --%</span>
          </div>
        </div>

        <!-- ì˜¤ëŠ˜ì˜ ê°ì • ì§ˆë¬¸ -->
        <div id="dailyQuestion" class="mt-5 p-4 rounded-2xl bg-gradient-to-r from-amber-50 to-pink-50 border border-amber-200">
          <p class="text-xs font-semibold text-amber-600 mb-1">ğŸ’¡ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</p>
          <p id="questionText" class="font-bold text-slate-700">ë¡œë”© ì¤‘...</p>
          <button id="answerQuestionBtn" class="mt-3 tap px-4 py-2 rounded-xl bg-white border border-amber-300 text-amber-700 font-semibold text-sm hover:bg-amber-50">
            ì´ ì§ˆë¬¸ì— ë‹µí•˜ê¸° â†’
          </button>
        </div>
      </section>

      <!-- ê°ì • íƒ­ -->
      <section class="flex flex-wrap gap-2 mb-4">
        <button data-emotion="all" class="emotion-btn tap px-4 py-2 rounded-full font-bold text-sm bg-white border-2 border-slate-300 text-slate-600 active">
          ğŸŒˆ ì „ì²´
        </button>
        <button data-emotion="hui" class="emotion-btn tap px-4 py-2 rounded-full font-bold text-sm bg-hui-50 border-2 border-hui-300 text-hui-700">
          ğŸ˜Š í¬ (ê¸°ì¨)
        </button>
        <button data-emotion="no" class="emotion-btn tap px-4 py-2 rounded-full font-bold text-sm bg-no-50 border-2 border-no-300 text-no-700">
          ğŸ˜¤ ë…¸ (ë¶„ë…¸)
        </button>
        <button data-emotion="ae" class="emotion-btn tap px-4 py-2 rounded-full font-bold text-sm bg-ae-50 border-2 border-ae-300 text-ae-700">
          ğŸ’• ì•  (ì‚¬ë‘)
        </button>
        <button data-emotion="rak" class="emotion-btn tap px-4 py-2 rounded-full font-bold text-sm bg-rak-50 border-2 border-rak-300 text-rak-700">
          ğŸ‰ ë½ (ì¦ê±°ì›€)
        </button>
      </section>

      <!-- ì •ë ¬ íƒ­ -->
      <section class="flex gap-2 mb-5">
        <button data-sort="hot" class="sortBtn tap px-3 py-1.5 rounded-lg font-semibold text-sm bg-orange-100 text-orange-700 border border-orange-200 active">
          ğŸ”¥ HOT
        </button>
        <button data-sort="new" class="sortBtn tap px-3 py-1.5 rounded-lg font-semibold text-sm bg-slate-100 text-slate-600 border border-slate-200">
          âœ¨ NEW
        </button>
      </section>

      <!-- í”¼ë“œ -->
      <section id="feed" class="space-y-4">
        <div class="text-center py-12 text-slate-400">ë¡œë”© ì¤‘...</div>
      </section>

      <!-- ë” ë³´ê¸° -->
      <div class="mt-6 text-center">
        <button id="loadMoreBtn" class="tap px-6 py-3 rounded-2xl glass font-bold text-slate-600 hover:bg-white/90 hidden">
          ë” ë³´ê¸° â†“
        </button>
      </div>

      <footer class="mt-12 pb-8 text-center text-xs text-slate-400">
        <p>Â© FunnyFunny Â· í¬ë…¸ì• ë½ ìµëª… ì° í”Œë«í¼</p>
        <a href="https://funnyfunny.cloud/" target="_blank" class="inline-block mt-2 px-4 py-2 rounded-xl bg-white/80 border border-slate-200 font-semibold text-slate-500 hover:bg-white">ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸°</a>
      </footer>
    </main>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="writeModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 modal-overlay"></div>
      <div class="absolute inset-0 flex items-end sm:items-center justify-center p-4">
        <div class="glass w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden card-enter">
          <div class="p-4 border-b border-slate-200 flex items-center justify-between">
            <div>
              <h3 class="text-lg font-black">âœï¸ ê°ì • ì° ì“°ê¸°</h3>
              <p class="text-xs text-slate-500">ê°ì •ì„ ì„ íƒí•˜ê³  íˆ­ í„¸ì–´ë†“ìœ¼ì„¸ìš”</p>
            </div>
            <button id="closeWriteBtn" class="tap px-3 py-1.5 rounded-xl bg-slate-100 text-slate-600 font-semibold hover:bg-slate-200">ë‹«ê¸°</button>
          </div>

          <div class="p-4 space-y-4">
            <!-- ê°ì • ì„ íƒ -->
            <div>
              <label class="text-sm font-semibold text-slate-600 mb-2 block">ê°ì • ì„ íƒ</label>
              <div class="flex flex-wrap gap-2">
                <button type="button" data-write-emotion="hui" class="writeEmotionBtn tap px-4 py-2 rounded-full font-bold text-sm bg-hui-100 border-2 border-hui-300 text-hui-700 hover:bg-hui-200">ğŸ˜Š í¬</button>
                <button type="button" data-write-emotion="no" class="writeEmotionBtn tap px-4 py-2 rounded-full font-bold text-sm bg-no-100 border-2 border-no-300 text-no-700 hover:bg-no-200">ğŸ˜¤ ë…¸</button>
                <button type="button" data-write-emotion="ae" class="writeEmotionBtn tap px-4 py-2 rounded-full font-bold text-sm bg-ae-100 border-2 border-ae-300 text-ae-700 hover:bg-ae-200">ğŸ’• ì• </button>
                <button type="button" data-write-emotion="rak" class="writeEmotionBtn tap px-4 py-2 rounded-full font-bold text-sm bg-rak-100 border-2 border-rak-300 text-rak-700 hover:bg-rak-200">ğŸ‰ ë½</button>
              </div>
            </div>

            <!-- í…œí”Œë¦¿ íŒíŠ¸ -->
            <div id="templateHint" class="p-3 rounded-xl bg-slate-50 border border-slate-200 text-sm text-slate-600 hidden">
              <p class="font-semibold mb-1">ğŸ’¡ ì´ë ‡ê²Œ ì¨ë³´ì„¸ìš”</p>
              <p id="templateText"></p>
            </div>

            <!-- ë‹‰ë„¤ì„ -->
            <div>
              <label class="text-sm font-semibold text-slate-600 mb-1 block">ë‹‰ë„¤ì„ (ì„ íƒ)</label>
              <input id="writeNickname" type="text" maxlength="20" placeholder="ìµëª…" class="w-full px-4 py-2.5 rounded-xl bg-white border border-slate-200 outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-100" />
            </div>

            <!-- ë³¸ë¬¸ -->
            <div>
              <label class="text-sm font-semibold text-slate-600 mb-1 block">ë³¸ë¬¸</label>
              <textarea id="writeBody" rows="5" maxlength="5000" placeholder="ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ íˆ­ í„¸ì–´ë†“ìœ¼ì„¸ìš”..." class="w-full px-4 py-3 rounded-xl bg-white border border-slate-200 outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-100 resize-none"></textarea>
              <div class="mt-1 flex justify-between text-xs text-slate-400">
                <span>ì¿¨íƒ€ì„: 30ì´ˆ</span>
                <span id="writeCount">0/5000</span>
              </div>
            </div>

            <div class="flex justify-end gap-2">
              <button id="submitWriteBtn" class="tap px-6 py-2.5 rounded-xl bg-gradient-to-r from-amber-400 to-pink-400 text-white font-bold shadow-lg hover:shadow-xl">
                ê²Œì‹œí•˜ê¸°
              </button>
            </div>

            <p id="writeError" class="text-sm text-red-500 hidden"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- ìƒì„¸ ëª¨ë‹¬ -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 modal-overlay"></div>
      <div class="absolute inset-0 flex items-end sm:items-center justify-center p-4 overflow-y-auto">
        <div id="detailContent" class="glass w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden card-enter my-4">
          <!-- ë™ì  ë Œë”ë§ -->
        </div>
      </div>
    </div>

    <script>
      // ============================
      // Supabase ì—°ê²° (flowì™€ ë™ì¼)
      // ============================
      const SUPABASE_URL = "https://vpezjsuzwmeozaytcqyv.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwZXpqc3V6d21lb3pheXRjcXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDA0OTIsImV4cCI6MjA3OTY3NjQ5Mn0.Fyjj5yrV2-6w1OKnQXWaL_-7_r1XpuUl-UQq6e6e5vc";
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ============================
      // ê°ì • ì„¤ì •
      // ============================
      const EMOTIONS = {
        hui: { emoji: 'ğŸ˜Š', label: 'í¬', color: 'hui', desc: 'ê¸°ì¨', slug: 'hui-joy' },
        no: { emoji: 'ğŸ˜¤', label: 'ë…¸', color: 'no', desc: 'ë¶„ë…¸', slug: 'no-anger' },
        ae: { emoji: 'ğŸ’•', label: 'ì• ', color: 'ae', desc: 'ì‚¬ë‘', slug: 'ae-love' },
        rak: { emoji: 'ğŸ‰', label: 'ë½', color: 'rak', desc: 'ì¦ê±°ì›€', slug: 'rak-joy' }
      };

      const TEMPLATES = {
        hui: 'ì˜¤ëŠ˜ ì œì¼ ê¸°ë»¤ë˜ ìˆœê°„ â†’ ëˆ„ê°€ ë´ë„ ê³µê°ë  í¬ì¸íŠ¸ â†’ í•œ ì¤„ ê²°ë¡ ',
        no: 'ìƒí™©(íŒ©íŠ¸) â†’ ë‚´ ê°ì • â†’ ë°”ë¼ëŠ” ê²ƒ(ìœ„ë¡œ or í•´ê²°)',
        ae: 'ìƒëŒ€ì—ê²Œ ë§ ëª»í•œ í•œ ë¬¸ì¥ â†’ ê³ ë§ˆì› ë˜ ì¥ë©´ â†’ ì§€ê¸ˆ ëŠë‚Œ',
        rak: 'ì›ƒê¸´ í¬ì¸íŠ¸ í•˜ë‚˜ â†’ ë°˜ì „ ìˆìœ¼ë©´ ë” ì¢‹ì•„ìš” â†’ ê²°ë§'
      };

      const DAILY_QUESTIONS = [
        { emotion: 'hui', q: 'ì˜¤ëŠ˜ ê´œíˆ ì›ƒìŒ ë‚˜ì˜¨ ìˆœê°„ì´ ìˆë‚˜ìš”?' },
        { emotion: 'no', q: 'ì˜¤ëŠ˜ ì œì¼ ì–´ì´ì—†ì—ˆë˜ ë§ í•œë§ˆë””ëŠ”?' },
        { emotion: 'ae', q: 'ì§€ê¸ˆ ë– ì˜¤ë¥´ëŠ” í•œ ì‚¬ëŒì´ ìˆë‹¤ë©´?' },
        { emotion: 'rak', q: 'ì˜¤ëŠ˜ ê°€ì¥ ì¬ë°Œì—ˆë˜ ì¥ë©´ì€?' },
        { emotion: 'hui', q: 'ì‘ì€ ê±°ì§€ë§Œ ê¸°ë»¤ë˜ ìˆœê°„ì„ ê³µìœ í•´ì£¼ì„¸ìš”!' },
        { emotion: 'no', q: 'ì°¸ë‹¤ ì°¸ë‹¤ í„°ì§„ ìˆœê°„ì´ ìˆì—ˆë‚˜ìš”?' },
        { emotion: 'ae', q: 'ìš”ì¦˜ ë§ˆìŒì— ë‹´ì•„ë‘” ì‚¬ëŒì´ ìˆë‚˜ìš”?' },
        { emotion: 'rak', q: 'ìµœê·¼ ë¹µ í„°ì§„ ì—í”¼ì†Œë“œë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”!' }
      ];

      // ============================
      // ìƒíƒœ
      // ============================
      let currentEmotion = 'all';
      let currentSort = 'hot';
      let posts = [];
      let offset = 0;
      const LIMIT = 20;

      // ============================
      // ìœ í‹¸
      // ============================
      const $ = sel => document.querySelector(sel);
      const $$ = sel => document.querySelectorAll(sel);

      function esc(s) {
        return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }

      function timeAgo(iso) {
        const diff = Math.max(0, Date.now() - new Date(iso).getTime());
        const m = Math.floor(diff / 60000);
        if (m < 1) return 'ë°©ê¸ˆ';
        if (m < 60) return `${m}ë¶„ ì „`;
        const h = Math.floor(m / 60);
        if (h < 24) return `${h}ì‹œê°„ ì „`;
        return `${Math.floor(h / 24)}ì¼ ì „`;
      }

      function getAnonId() {
        let v = localStorage.getItem('emote_anon');
        if (!v) {
          v = crypto?.randomUUID?.() || Date.now() + '-' + Math.random().toString(16).slice(2);
          localStorage.setItem('emote_anon', v);
        }
        return v;
      }

      function inCooldown() {
        const until = Number(localStorage.getItem('emote_cd') || '0');
        return Date.now() < until;
      }

      function setCooldown(ms) {
        localStorage.setItem('emote_cd', String(Date.now() + ms));
      }

      const anonId = getAnonId();

      // ê°ì • ì¶”ì¶œ (ë³¸ë¬¸ ë˜ëŠ” íƒœê·¸ì—ì„œ)
      function detectEmotion(post) {
        const body = (post.body || '').toLowerCase();
        const boardSlug = post.board?.slug || '';
        for (const [key, val] of Object.entries(EMOTIONS)) {
          if (boardSlug.includes(key) || boardSlug.includes(val.slug)) return key;
        }
        // ì´ëª¨ì§€ ê¸°ë°˜ ì¶”ì¸¡
        if (/ğŸ˜Š|ê¸°ì¨|ì¢‹|í–‰ë³µ|ê°ì‚¬/.test(body)) return 'hui';
        if (/ğŸ˜¤|í™”|ì—´ë°›|ì§œì¦|ë¶„ë…¸|ì–µìš¸/.test(body)) return 'no';
        if (/ğŸ’•|ì‚¬ë‘|ì„¤ë ˜|ì¢‹ì•„|ì—°ì¸|ê°ë™/.test(body)) return 'ae';
        if (/ğŸ‰|ì¬ë°Œ|ì›ƒ|ã…‹|ã…|ì¦ê±°|ì‹ ë‚¨/.test(body)) return 'rak';
        // ëœë¤ í´ë°±
        const keys = Object.keys(EMOTIONS);
        return keys[Math.abs(hashCode(post.id || '')) % keys.length];
      }

      function hashCode(s) {
        let h = 0;
        for (let i = 0; i < s.length; i++) h = ((h << 5) - h + s.charCodeAt(i)) | 0;
        return h;
      }

      // HOT ì ìˆ˜ ê³„ì‚° (ì¶”ì²œ + ì‹œê°„ ê°ì‡ )
      function hotScore(post) {
        const empathy = post.empathy_count || 0;
        const comments = post.comment_count || 0;
        const age = (Date.now() - new Date(post.created_at).getTime()) / 3600000; // hours
        return (empathy * 2 + comments) / Math.pow(age + 2, 1.3);
      }

      // ============================
      // ì˜¤ëŠ˜ì˜ ì§ˆë¬¸
      // ============================
      function setDailyQuestion() {
        const dayIdx = new Date().getDate() % DAILY_QUESTIONS.length;
        const q = DAILY_QUESTIONS[dayIdx];
        $('#questionText').textContent = q.q;
        $('#answerQuestionBtn').dataset.emotion = q.emotion;
      }

      $('#answerQuestionBtn').addEventListener('click', () => {
        const emotion = $('#answerQuestionBtn').dataset.emotion;
        openWriteModal(emotion, DAILY_QUESTIONS.find(q => q.emotion === emotion)?.q);
      });

      // ============================
      // ê°ì • ë¹„ìœ¨ ë¡œë“œ
      // ============================
      async function loadEmotionRatio() {
        try {
          const { data } = await sb.from('posts').select('id, body, board:boards(slug)').eq('is_hidden', false).limit(200);
          if (!data) return;
          const counts = { hui: 0, no: 0, ae: 0, rak: 0 };
          data.forEach(p => {
            const e = detectEmotion(p);
            if (counts[e] !== undefined) counts[e]++;
          });
          const total = Object.values(counts).reduce((a, b) => a + b, 0) || 1;
          const ratio = $('#emotionRatio');
          ratio.innerHTML = `
            <span class="px-2 py-1 rounded-full bg-hui-100 text-hui-600">í¬ ${Math.round(counts.hui / total * 100)}%</span>
            <span class="px-2 py-1 rounded-full bg-no-100 text-no-600">ë…¸ ${Math.round(counts.no / total * 100)}%</span>
            <span class="px-2 py-1 rounded-full bg-ae-100 text-ae-600">ì•  ${Math.round(counts.ae / total * 100)}%</span>
            <span class="px-2 py-1 rounded-full bg-rak-100 text-rak-600">ë½ ${Math.round(counts.rak / total * 100)}%</span>
          `;
        } catch (e) { console.error(e); }
      }

      // ============================
      // í”¼ë“œ ë¡œë“œ
      // ============================
      async function loadFeed(append = false) {
        if (!append) {
          offset = 0;
          $('#feed').innerHTML = '<div class="text-center py-12 text-slate-400">ë¡œë”© ì¤‘...</div>';
        }

        try {
          let q = sb.from('posts')
            .select('id, body, author_name, anon_id, created_at, comment_count, empathy_count, is_hidden, board:boards(id, slug, title)')
            .eq('is_hidden', false)
            .range(offset, offset + LIMIT - 1);

          if (currentSort === 'new') {
            q = q.order('created_at', { ascending: false });
          } else {
            q = q.order('empathy_count', { ascending: false });
          }

          const { data, error } = await q;
          if (error) throw error;

          let filtered = data || [];

          // ê°ì • í•„í„°
          if (currentEmotion !== 'all') {
            filtered = filtered.filter(p => detectEmotion(p) === currentEmotion);
          }

          // HOT ì •ë ¬ ì‹œ ì¬ì •ë ¬
          if (currentSort === 'hot') {
            filtered.sort((a, b) => hotScore(b) - hotScore(a));
          }

          if (append) {
            posts = [...posts, ...filtered];
          } else {
            posts = filtered;
          }

          renderFeed();
          offset += LIMIT;

          $('#loadMoreBtn').classList.toggle('hidden', (data?.length || 0) < LIMIT);
        } catch (e) {
          console.error(e);
          $('#feed').innerHTML = '<div class="text-center py-12 text-red-400">ë¡œë”© ì‹¤íŒ¨</div>';
        }
      }

      function renderFeed() {
        if (posts.length === 0) {
          $('#feed').innerHTML = `
            <div class="glass rounded-2xl p-8 text-center">
              <p class="text-4xl mb-3">ğŸ“</p>
              <p class="font-bold text-slate-600">ì•„ì§ ì°ì´ ì—†ì–´ìš”</p>
              <p class="text-sm text-slate-400 mt-1">ì²« ë²ˆì§¸ë¡œ ê°ì •ì„ í„¸ì–´ë†“ì•„ ë³´ì„¸ìš”!</p>
              <button onclick="openWriteModal()" class="tap mt-4 px-5 py-2 rounded-xl bg-gradient-to-r from-amber-400 to-pink-400 text-white font-bold">
                ì° ì“°ê¸° â†’
              </button>
            </div>
          `;
          return;
        }

        $('#feed').innerHTML = posts.map((p, i) => {
          const emotion = detectEmotion(p);
          const em = EMOTIONS[emotion];
          const isHot = p.empathy_count >= 3;
          const summary = extractSummary(p.body);
          const preview = p.body.slice(0, 120) + (p.body.length > 120 ? '...' : '');

          return `
            <article class="glass rounded-2xl p-4 card-enter cursor-pointer hover:shadow-lg transition-shadow" data-post-id="${p.id}" style="animation-delay: ${i * 50}ms">
              <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-full bg-${em.color}-100 flex items-center justify-center text-xl flex-shrink-0">
                  ${em.emoji}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="px-2 py-0.5 rounded-full text-xs font-bold bg-${em.color}-100 text-${em.color}-700">${em.emoji} ${em.label}</span>
                    ${isHot ? '<span class="px-2 py-0.5 rounded-full text-xs font-bold text-white hot-badge">ğŸ”¥ HOT</span>' : ''}
                    <span class="text-xs text-slate-400">${esc(p.author_name || 'ìµëª…')} Â· ${timeAgo(p.created_at)}</span>
                  </div>
                  ${summary ? `<p class="mt-1 font-bold text-slate-800">${esc(summary)}</p>` : ''}
                  <p class="mt-1 text-sm text-slate-600 line-clamp-2">${esc(preview)}</p>
                  <div class="mt-2 flex items-center gap-3 text-xs text-slate-500">
                    <span class="flex items-center gap-1">â¤ï¸ ${p.empathy_count || 0}</span>
                    <span class="flex items-center gap-1">ğŸ’¬ ${p.comment_count || 0}</span>
                  </div>
                </div>
              </div>
            </article>
          `;
        }).join('');

        // í´ë¦­ ì´ë²¤íŠ¸
        $$('#feed article[data-post-id]').forEach(el => {
          el.addEventListener('click', () => openDetail(el.dataset.postId));
        });
      }

      function extractSummary(body) {
        // ì²« ì¤„ì´ ì§§ìœ¼ë©´ ìš”ì•½ìœ¼ë¡œ ì‚¬ìš©
        const lines = body.split('\n').filter(l => l.trim());
        if (lines[0] && lines[0].length <= 50 && lines.length > 1) {
          return lines[0];
        }
        return '';
      }

      // ============================
      // ìƒì„¸ ë³´ê¸°
      // ============================
      async function openDetail(postId) {
        const post = posts.find(p => p.id === postId);
        if (!post) return;

        const emotion = detectEmotion(post);
        const em = EMOTIONS[emotion];

        // ëŒ“ê¸€ ë¡œë“œ
        const { data: comments } = await sb.from('comments')
          .select('id, body, author_name, created_at')
          .eq('post_id', postId)
          .order('created_at', { ascending: true });

        const commentsHtml = (comments || []).map(c => `
          <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
            <div class="flex items-center gap-2 text-xs text-slate-500 mb-1">
              <span class="font-semibold text-slate-700">${esc(c.author_name || 'ìµëª…')}</span>
              <span>Â·</span>
              <span>${timeAgo(c.created_at)}</span>
            </div>
            <p class="text-sm text-slate-700">${esc(c.body)}</p>
          </div>
        `).join('');

        $('#detailContent').innerHTML = `
          <div class="p-4 border-b border-slate-200 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="px-2 py-1 rounded-full text-sm font-bold bg-${em.color}-100 text-${em.color}-700">${em.emoji} ${em.label}</span>
              <span class="text-sm text-slate-500">${esc(post.author_name || 'ìµëª…')} Â· ${timeAgo(post.created_at)}</span>
            </div>
            <button onclick="closeDetail()" class="tap px-3 py-1.5 rounded-xl bg-slate-100 text-slate-600 font-semibold hover:bg-slate-200">ë‹«ê¸°</button>
          </div>
          <div class="p-4">
            <p class="text-slate-800 whitespace-pre-wrap leading-relaxed">${esc(post.body)}</p>
            <div class="mt-4 flex items-center gap-4">
              <button onclick="empathize('${postId}')" class="tap flex items-center gap-2 px-4 py-2 rounded-xl bg-pink-50 text-pink-600 font-semibold border border-pink-200 hover:bg-pink-100">
                â¤ï¸ ê³µê° ${post.empathy_count || 0}
              </button>
              <span class="text-sm text-slate-500">ğŸ’¬ ëŒ“ê¸€ ${post.comment_count || 0}</span>
            </div>
          </div>
          <div class="p-4 border-t border-slate-200">
            <h4 class="font-bold text-slate-700 mb-3">ğŸ’¬ ëŒ“ê¸€</h4>
            <div class="space-y-2 mb-4 max-h-60 overflow-y-auto">
              ${commentsHtml || '<p class="text-sm text-slate-400">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”</p>'}
            </div>
            <div class="flex gap-2">
              <input id="commentInput" type="text" maxlength="500" placeholder="ê³µê°ì˜ í•œë§ˆë””..." class="flex-1 px-3 py-2 rounded-xl bg-white border border-slate-200 outline-none focus:border-amber-400" />
              <button onclick="submitComment('${postId}')" class="tap px-4 py-2 rounded-xl bg-amber-400 text-white font-bold">ë“±ë¡</button>
            </div>
          </div>
        `;

        $('#detailModal').classList.remove('hidden');
      }

      function closeDetail() {
        $('#detailModal').classList.add('hidden');
      }

      $('#detailModal').addEventListener('click', e => {
        if (e.target === $('#detailModal') || e.target.classList.contains('modal-overlay')) {
          closeDetail();
        }
      });

      // ============================
      // ê³µê° / ëŒ“ê¸€
      // ============================
      async function empathize(postId) {
        const key = `emote_emp_${postId}`;
        if (localStorage.getItem(key)) {
          alert('ì´ë¯¸ ê³µê°í–ˆì–´ìš”!');
          return;
        }
        try {
          await sb.rpc('increment_empathy', { row_id: postId });
          localStorage.setItem(key, '1');
          alert('ê³µê°í–ˆì–´ìš” â¤ï¸');
          loadFeed();
          closeDetail();
        } catch (e) {
          console.error(e);
          alert('ê³µê° ì‹¤íŒ¨');
        }
      }

      async function submitComment(postId) {
        const body = $('#commentInput').value.trim();
        if (!body) return alert('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        if (inCooldown()) return alert('ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');

        try {
          const { error } = await sb.from('comments').insert({
            post_id: postId,
            body,
            author_name: 'ìµëª…',
            anon_id: anonId
          });
          if (error) throw error;
          setCooldown(10000);
          openDetail(postId);
        } catch (e) {
          console.error(e);
          alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨');
        }
      }

      // ============================
      // ê¸€ì“°ê¸° ëª¨ë‹¬
      // ============================
      let selectedEmotion = '';

      function openWriteModal(emotion = '', prefill = '') {
        $('#writeModal').classList.remove('hidden');
        $('#writeBody').value = prefill ? `[ì˜¤ëŠ˜ì˜ ì§ˆë¬¸: ${prefill}]\n\n` : '';
        $('#writeCount').textContent = `${$('#writeBody').value.length}/5000`;
        if (emotion) selectWriteEmotion(emotion);
      }

      function closeWriteModal() {
        $('#writeModal').classList.add('hidden');
        selectedEmotion = '';
        $$('.writeEmotionBtn').forEach(b => b.classList.remove('ring-2', 'ring-offset-2'));
        $('#templateHint').classList.add('hidden');
      }

      $('#openWriteBtn').addEventListener('click', () => openWriteModal());
      $('#closeWriteBtn').addEventListener('click', closeWriteModal);
      $('#writeModal').addEventListener('click', e => {
        if (e.target === $('#writeModal') || e.target.classList.contains('modal-overlay')) {
          closeWriteModal();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;
        if (!$('#writeModal').classList.contains('hidden')) closeWriteModal();
        else if (!$('#detailModal').classList.contains('hidden')) closeDetail();
      });

      function selectWriteEmotion(emotion) {
        selectedEmotion = emotion;
        $$('.writeEmotionBtn').forEach(b => {
          const isActive = b.dataset.writeEmotion === emotion;
          b.classList.toggle('ring-2', isActive);
          b.classList.toggle('ring-offset-2', isActive);
        });
        $('#templateHint').classList.remove('hidden');
        $('#templateText').textContent = TEMPLATES[emotion];
      }

      $$('.writeEmotionBtn').forEach(btn => {
        btn.addEventListener('click', () => selectWriteEmotion(btn.dataset.writeEmotion));
      });

      $('#writeBody').addEventListener('input', () => {
        $('#writeCount').textContent = `${$('#writeBody').value.length}/5000`;
      });

      $('#writeBody').addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
          e.preventDefault();
          $('#submitWriteBtn').click();
        }
      });

      $('#submitWriteBtn').addEventListener('click', async () => {
        if (!selectedEmotion) return alert('ê°ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        const body = $('#writeBody').value.trim();
        if (!body) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        if (inCooldown()) return alert('ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');

        const nickname = $('#writeNickname').value.trim() || 'ìµëª…';

        try {
          // í•´ë‹¹ ê°ì •ì˜ board ì°¾ê¸° ë˜ëŠ” ìƒì„±
          let { data: board } = await sb.from('boards').select('id').eq('slug', EMOTIONS[selectedEmotion].slug).single();

          if (!board) {
            const { data: newBoard, error: createErr } = await sb.from('boards').insert({
              slug: EMOTIONS[selectedEmotion].slug,
              title: `${EMOTIONS[selectedEmotion].emoji} ${EMOTIONS[selectedEmotion].label} (${EMOTIONS[selectedEmotion].desc})`,
              description: `${EMOTIONS[selectedEmotion].desc} ê°ì •ì˜ ì°ì„ ë‚˜ëˆ„ëŠ” ê³µê°„`,
              is_active: true
            }).select().single();
            if (createErr) throw createErr;
            board = newBoard;
          }

          const { error } = await sb.from('posts').insert({
            board_id: board.id,
            body,
            author_name: nickname,
            anon_id: anonId
          });

          if (error) throw error;

          setCooldown(30000);
          closeWriteModal();
          loadFeed();
          loadEmotionRatio();
          alert('ì°ì´ ë“±ë¡ëì–´ìš”! ğŸ‰');
        } catch (e) {
          console.error(e);
          $('#writeError').textContent = 'ë“±ë¡ ì‹¤íŒ¨: ' + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
          $('#writeError').classList.remove('hidden');
        }
      });

      // ============================
      // íƒ­ ì´ë²¤íŠ¸
      // ============================
      $$('.emotion-btn[data-emotion]').forEach(btn => {
        btn.addEventListener('click', () => {
          currentEmotion = btn.dataset.emotion;
          $$('.emotion-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          loadFeed();
        });
      });

      $$('.sortBtn[data-sort]').forEach(btn => {
        btn.addEventListener('click', () => {
          currentSort = btn.dataset.sort;
          $$('.sortBtn').forEach(b => {
            b.classList.remove('bg-orange-100', 'text-orange-700', 'border-orange-200');
            b.classList.add('bg-slate-100', 'text-slate-600', 'border-slate-200');
          });
          btn.classList.remove('bg-slate-100', 'text-slate-600', 'border-slate-200');
          btn.classList.add('bg-orange-100', 'text-orange-700', 'border-orange-200');
          loadFeed();
        });
      });

      $('#loadMoreBtn').addEventListener('click', () => loadFeed(true));

      // ============================
      // ì´ˆê¸°í™”
      // ============================
      setDailyQuestion();
      loadEmotionRatio();
      loadFeed();
    </script>
  </body>
</html>
